define(["./common","jquery","./controller/controller","./utils/helpers","components/slider","text!../templates/video_controlbar.html","text!../templates/controlbar.html","text!../templates/volume_slider.html","utils/ui","utils/storage","utils/underscore","utils/extendable","./components/rightclick"],function(e,t,l,n,i,o,s,a,r,m,d,u,c){if(!t)return void console.log(t);n.log("flashVersion",n.flashVersion());var h=new m,v=u.extend({constructor:function(e){return this.config=e||{},this.elementContainer=document.getElementById(e.id),this.elementBody=document.getElementsByTagName("body")[0],this.elementContainer?(this.$container=t(this.elementContainer),this.$container.addClass("prism-player jx-size js-player"),this.providerType=e.type,this.init(),!e.debug,(new c).setup({},this.elementContainer,this.elementContainer),void 0):void n.log("no elementContainer find by",e.id)},setup:function(){var e={id:"J_prismPlayer",source:"http://res.skillbridge.cn/video/dkx1.mp4",autoplay:!1,width:"100%",height:"530px",showBarTime:"3000",skinRes:"http://localhost:8008/view/player/flash/1.2.4/atlas/skin",skinLayout:[{name:"bigPlayButton",align:"blabs",x:30,y:80},{name:"controlBar",align:"blabs",x:0,y:0,children:[{name:"progress",align:"tlabs",x:0,y:0},{name:"playButton",align:"tlabs",x:20,y:25},{name:"timeDisplay",align:"tlabs",x:100,y:23},{name:"volume",align:"trabs",x:323,y:23},{name:"fullScreenButton",align:"trabs",x:116,y:23}]}]},m=d.extend(e,this.config);m.width.indexOf("%")<0&&parseInt(m.width)<600&&(delete m.skinLayout,this.providerType=2,this.elementContainer.addEventListener("mouseout",function(e){}));var u=this,c=new prismplayer(m);if(u.aliPlayer=c,this.elementContainer.addEventListener("mouseover",function(e){t(u.elementControlBar).css("bottom","0px")}),c.on("pause",function(){window.onPlayPaused&&onPlayPaused()}),c.on("play",function(){window.onPlayResume&&onPlayResume()}),c.on("ready",function(){console.log("播放器初始化完毕可以播放视频时触发 s"),u.isReady=!0,window.on_player_start&&on_player_start()}),c.on("uiReady",function(){console.log("uiReady")}),c.on("uiH5Ready",function(){n.log("uiH5Ready"),u.isReady=!0}),c.on("url:change",function(){if(0==u.providerType){console.log("url change");var e=t(u.elementRate).find(".active"),l=e.data("rate")||1;u.controller.setPlaybackRate(l)}}),m.resize&&u.$container.css("height","100%"),1!=this.providerType&&(u.isReady=!0),0==this.providerType){this.elementVolume=this.getElementByClassName("prism-volume"),this.elementControlBar=this.getElementByClassName("prism-controlbar");var v=t(this.elementControlBar);v.append(o),this.elementVolumeSlider=this.getElementByClassName("j_volume_slider"),this.elementProvider=this.getElementByClassName("provider-select-wrap"),this.elementRate=this.getElementByClassName("rate-select-wrap"),this.elementHd=this.getElementByClassName("hd-select-wrap"),this.elementNext=this.getElementByClassName("next-period-wrap"),t(this.elementVolume).css("right","405px");var p=new i(this.elementVolumeSlider,"jx-volume-slider","horizontal"),y=new l(c);u.controller=y,new r(this.elementHd).on("click",function(e){n.log("hd select evt",e);var l=t(e.target),i=l.html().substr(0,2),o=l.data("value");l.siblings().removeClass("active"),l.addClass("active"),t(u.elementHd).prev().html(i),u.aliPlayer.continuePlayTime=u.aliPlayer.getCurrentTime(),window.playModule&&window.playModule.switchHd(o)}),new r(this.elementProvider).on("click",function(e){n.log("player select evt",e);var l=t(e.target),i=l.data("type");h.setItem("providerType",i),window.location.reload()}),new r(this.elementRate).on("click",function(e){n.log("rate select evt",e);var l=t(e.target),i=l.data("rate"),o=l.html();l.siblings().removeClass("active"),l.addClass("active"),n.log("change rate to ",i);var s=y.getPlaybackRate();n.log("current video rate is",s),y.setPlaybackRate(i),t(".rate-selected").html(o)}),new r(this.elementNext).on("click",function(e){n.log("elementNext click",e),window.playModule&&window.playModule.playNext()}),this.elementPeriodState=this.getElementByClassName("period-state-wrap"),new r(this.elementPeriodState).on("click",function(e){n.log("elementPeriodState click",e),window.playModule&&window.playModule.setPeriodLearned()});var u=this;this.volumeSlider=p,this.volumeSlider.on("update",function(e){n.log("volume update",e),y.setVolume(e.percentage);var l=Math.round(e.percentage);l?(t(u.elementVolume).removeClass("mute"),u.aliPlayer.tag.muted=!1):(t(u.elementVolume).addClass("mute"),u.aliPlayer.tag.muted=!0),h.setItem("volume",l),t(u.elementVolumeSlider).find(".title").html(l+"%").css("visibility","visible");var i=setTimeout(function(){t(u.elementVolumeSlider).find(".title").css("visibility","hidden"),clearInterval(i)},1e3)})}else if(1==this.providerType)this.$container.append(s),this.elementProvider=this.getElementByClassName("provider-select-wrap"),this.elementHd=this.getElementByClassName("hd-select-wrap"),this.elementNext=this.getElementByClassName("next-period-wrap"),new r(this.elementProvider).on("click",function(e){n.log("player select evt",e);var l=t(e.target),i=l.data("type");h.setItem("providerType",i),window.location.reload()}),new r(this.elementHd).on("click",function(e){n.log("hd select evt",e);var l=t(e.target),i=l.html().substr(0,2),o=l.data("value");l.siblings().removeClass("active"),l.addClass("active"),t(u.elementHd).prev().html(i),window.playModule&&window.playModule.switchHd(o)}),new r(this.elementNext).on("click",function(e){n.log("elementNext click",e),window.playModule&&window.playModule.playNext()}),this.elementPeriodState=this.getElementByClassName("period-state-wrap"),new r(this.elementPeriodState).on("click",function(e){n.log("elementPeriodState click",e),window.playModule&&window.playModule.setPeriodLearned()});else if(2==this.providerType){var u=this,y=new l(c);if(u.controller=y,this.elementVolume=this.getElementByClassName("prism-volume"),!this.elementVolume)return;this.$container.addClass("s-size-container"),this.elementControlBar=this.getElementByClassName("prism-controlbar");var v=t(this.elementControlBar);v.append(a),this.elementVolumeSlider=this.getElementByClassName("j_volume_slider");var p=new i(this.elementVolumeSlider,"jx-volume-slider","vertical");new r(this.elementVolume,{useHover:!0,useMove:!0}).on("over",function(e){u.elementVolumeSlider.style.display="block"}).on("out",function(e){u.elementVolumeSlider.style.display="none"}),new r(this.elementVolumeSlider,{useHover:!0,useMove:!0}).on("over",function(e){u.elementVolumeSlider.style.display="block"}).on("out",function(e){u.elementVolumeSlider.style.display="none"}),this.volumeSlider=p,this.volumeSlider.on("update",function(e){n.log("volume update",e),y.setVolume(e.percentage);var l=Math.round(e.percentage);l?(t(u.elementVolume).removeClass("mute"),u.aliPlayer.tag.muted=!1):(t(u.elementVolume).addClass("mute"),u.aliPlayer.tag.muted=!0),h.setItem("volume",l)})}},getElementByClassName:function(e){return this.elementContainer.getElementsByClassName(e)[0]},bindEvents:function(){var e=this,l=e.$container;l.on("click",".prism-volume",function(l){if(/prism-volume mute/.test(l.target.className))e.volumeSlider.render(0),t(l.target).addClass("mute");else{t(l.target).removeClass("mute"),console.log("prism-volume click");var n=h.getItem("volume")||50;e.volumeSlider.render(n),e.controller.setVolume(n)}}),l.on("click",".jx-btn-fullbrowser",function(e){l.toggleClass("jx-size jx-flag-fullscreen")}),t(window).off("resize"),t(window).resize(function(){if(n.log("resize"),e.$resizeContainer&&l.css("height",e.$resizeContainer.height()),!n.isFullScreen()&&t(".prism-fullscreen").length>0){n.log("exitFullScreen");var i=t(".prism-fullscreen");i.removeClass("prism-fullscreen"),i.find(".fullscreen").removeClass("fullscreen")}})},activePlayerSelectedEl:function(e){var e=e||h.getItem("providerType")||0,l=t(this.elementProvider);l.find(".active").removeClass("active"),l.find("li").eq(e).addClass("active")},init:function(e){var t=this;t.setup(),t.bindEvents(),t.activePlayerSelectedEl()}});return v});