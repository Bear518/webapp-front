define(["utils/backbone.events","utils/events","utils/helpers","utils/underscore"],function(e,t,n,o){function r(e,t){return/touch/.test(e.type)?(e.originalEvent||e).changedTouches[0]["page"+t]:e["page"+t]}function i(e){var t=e||window.event;return e instanceof MouseEvent&&("which"in t?3===t.which:"button"in t&&2===t.button)}function v(e,t,n){var o;return o=t instanceof MouseEvent||!t.touches&&!t.changedTouches?t:t.touches&&t.touches.length?t.touches[0]:t.changedTouches[0],{type:e,target:t.target,currentTarget:n,pageX:o.pageX,pageY:o.pageY}}function s(e){(e instanceof MouseEvent||e instanceof window.TouchEvent)&&(e.preventManipulation&&e.preventManipulation(),e.preventDefault&&e.preventDefault())}var u=!o.isUndefined(window.PointerEvent),c=!u&&n.isMobile(),a=!u&&!c,d=n.isFF()&&n.isOSX(),E=function(e,n){function c(e){(a||u&&"touch"!==e.pointerType)&&l(t.touchEvents.OVER,e)}function E(e){(a||u&&"touch"!==e.pointerType)&&l(t.touchEvents.MOVE,e)}function m(n){(a||u&&"touch"!==n.pointerType&&!e.contains(document.elementFromPoint(n.x,n.y)))&&l(t.touchEvents.OUT,n)}function p(t){g=t.target,C=r(t,"X"),y=r(t,"Y"),i(t)||(u?t.isPrimary&&(n.preventScrolling&&(f=t.pointerId,e.setPointerCapture(f)),e.addEventListener("pointermove",L),e.addEventListener("pointercancel",h),e.addEventListener("pointerup",h)):a&&(document.addEventListener("mousemove",L),d&&"object"===t.target.nodeName.toLowerCase()?e.addEventListener("click",h):document.addEventListener("mouseup",h)),g.addEventListener("touchmove",L),g.addEventListener("touchcancel",h),g.addEventListener("touchend",h),n.preventScrolling&&s(t))}function L(e){var o=t.touchEvents,i=6;if(T)l(o.DRAG,e);else{var v=r(e,"X"),u=r(e,"Y"),c=v-C,a=u-y;c*c+a*a>i*i&&(l(o.DRAG_START,e),T=!0,l(o.DRAG,e))}n.preventScrolling&&s(e)}function h(o){var r=t.touchEvents;u?(n.preventScrolling&&e.releasePointerCapture(f),e.removeEventListener("pointermove",L),e.removeEventListener("pointercancel",h),e.removeEventListener("pointerup",h)):a&&(document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",h)),g&&(g.removeEventListener("touchmove",L),g.removeEventListener("touchcancel",h),g.removeEventListener("touchend",h)),T?l(r.DRAG_END,o):n.directSelect&&o.target!==e||o.type.indexOf("cancel")!==-1||(u&&o instanceof window.PointerEvent?"touch"===o.pointerType?l(r.TAP,o):l(r.CLICK,o):a?l(r.CLICK,o):(l(r.TAP,o),s(o))),g=null,T=!1}function l(e,r){var i;if(n.enableDoubleTap&&(e===t.touchEvents.CLICK||e===t.touchEvents.TAP))if(o.now()-P<D){var s=e===t.touchEvents.CLICK?t.touchEvents.DOUBLE_CLICK:t.touchEvents.DOUBLE_TAP;i=v(s,r,w),A.trigger(s,i),P=0}else P=o.now();i=v(e,r,w),A.trigger(e,i)}var g,f,w=e,T=!1,C=0,y=0,P=0,D=300;n=n||{},u?(e.addEventListener("pointerdown",p),n.useHover&&(e.addEventListener("pointerover",c),e.addEventListener("pointerout",m)),n.useMove&&e.addEventListener("pointermove",E)):a&&(e.addEventListener("mousedown",p),n.useHover&&(e.addEventListener("mouseover",c),e.addEventListener("mouseout",m)),n.useMove&&e.addEventListener("mousemove",E)),e.addEventListener("touchstart",p);var A=this;return this.triggerEvent=l,this.destroy=function(){e.removeEventListener("touchstart",p),e.removeEventListener("mousedown",p),g&&(g.removeEventListener("touchmove",L),g.removeEventListener("touchcancel",h),g.removeEventListener("touchend",h)),u&&(n.preventScrolling&&e.releasePointerCapture(f),e.removeEventListener("pointerover",c),e.removeEventListener("pointerdown",p),e.removeEventListener("pointermove",L),e.removeEventListener("pointermove",E),e.removeEventListener("pointercancel",h),e.removeEventListener("pointerout",m),e.removeEventListener("pointerup",h)),e.removeEventListener("click",h),e.removeEventListener("mouseover",c),e.removeEventListener("mousemove",E),e.removeEventListener("mouseout",m),document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",h)},this};return o.extend(E.prototype,e),E});